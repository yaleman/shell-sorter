<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shell Tagging - Shell Sorter</title>
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè∑Ô∏è Shell Image Tagging</h1>
            <div class="tagging-status">
                Session: {{ session_id }}
            </div>
        </header>

        <main class="tagging-main">
            <section class="tagging-panel">
                <h2>Captured Images</h2>
                <div class="images-grid" id="images-grid">
                    {% for image in captured_images %}
                    <div class="image-item" data-filename="{{ image.filename }}">
                        <div class="image-preview">
                            <img src="/images/{{ image.filename }}" alt="Camera {{ image.camera_index }} capture" class="captured-image">
                            <div class="camera-label">{{ image.camera_name }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <section class="tagging-form-panel">
                <h2>Shell Information</h2>
                <form id="tagging-form" class="tagging-form">
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <input type="hidden" name="image_filenames" value="{{ captured_images | map(attribute='filename') | list | tojson }}">
                    
                    <div class="form-group">
                        <label for="brand">Brand:</label>
                        <input type="text" name="brand" id="brand" required placeholder="e.g., Winchester, Federal, PMC">
                    </div>
                    
                    <div class="form-group">
                        <label for="shell_type">Shell Type:</label>
                        <select name="shell_type" id="shell_type" required>
                            <option value="">Select shell type</option>
                            {% for case_type in supported_case_types %}
                            <option value="{{ case_type }}">{{ case_type }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Shell Data</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <!-- Toast notification container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="/static/script.js"></script>
    <script>
        // Tagging-specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('tagging-form');
            const cancelBtn = document.getElementById('cancel-btn');

            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(form);
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);

                        const response = await fetch('/api/shells/save', {
                            method: 'POST',
                            body: formData,
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (response.ok) {
                            const result = await response.json();
                            showToast('Shell data saved successfully!', 'success');
                            // Redirect back to dashboard after short delay
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 2000);
                        } else {
                            const error = await response.text();
                            showToast('Error saving shell data: ' + error, 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        if (error.name === 'AbortError') {
                            showToast('Request timed out. Please try again.', 'warning');
                        } else {
                            showToast('Error saving shell data: ' + error.message, 'error');
                        }
                    }
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to cancel? Captured images will be discarded.')) {
                        window.location.href = '/';
                    }
                });
            }
        });
    </script>
</body>
</html>